name: Upstream Sync and Deploy

# èµ‹äºˆå·¥ä½œæµå†™å…¥å†…å®¹ï¼ˆåŒæ­¥forkï¼‰å’Œæ‰§è¡Œæ“ä½œï¼ˆè§¦å‘å…¶ä»–å·¥ä½œæµï¼‰çš„æƒé™
permissions:
  contents: write
  actions: write

on:
  schedule:
    - cron: "0 0 * * *" # æ¯å¤©æ‰§è¡Œä¸€æ¬¡
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  sync_latest_from_upstream:
    name: Sync latest commits from upstream repo
    runs-on: ubuntu-latest
    # ä»…å½“ä»“åº“æ˜¯ fork æ—¶è¿è¡Œ
    if: ${{ github.event.repository.fork }}

    steps:
      # æ­¥éª¤ 1: æ£€å‡ºç›®æ ‡ä»“åº“ä»£ç 
      - name: Checkout target repo
        uses: actions/checkout@v4 # å»ºè®®ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬

      # æ­¥éª¤ 2: ä¸ä¸Šæ¸¸ä»“åº“åŒæ­¥æ›´æ”¹
      - name: Sync upstream changes
        id: sync
        uses: aormsby/Fork-Sync-With-Upstream-action@v3.4
        with:
          upstream_sync_repo: beilunyang/moemail
          upstream_sync_branch: master
          target_sync_branch: master
          target_repo_token: ${{ secrets.GITHUB_TOKEN }} # GitHub è‡ªåŠ¨ç”Ÿæˆï¼Œæ— éœ€è®¾ç½®
          # å°† test_mode è®¾ç½®ä¸º true ä»¥è¿è¡Œæµ‹è¯•è€Œä¸æ˜¯å®é™…æ“ä½œ
          test_mode: false

      # æ­¥éª¤ 3: æ£€æŸ¥åŒæ­¥çŠ¶æ€å¹¶å†³å®šæ˜¯å¦è§¦å‘ Deploy å·¥ä½œæµ
      - name: Check sync status and trigger Deploy workflow
        # ä»…å½“ 'sync' æ­¥éª¤æˆåŠŸå¹¶ä¸”æœ‰æ–°çš„æäº¤æ—¶æ‰§è¡Œ
        if: steps.sync.outcome == 'success' && steps.sync.outputs.has_new_commits == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }} # ç”¨äº gh CLI è®¤è¯
          OWNER_REPO: ${{ github.repository }} # å½“å‰ä»“åº“ï¼Œä¾‹å¦‚ "your-username/your-repo"
        run: |
          echo "âœ… ä¸Šæ¸¸åŒæ­¥æˆåŠŸï¼Œå¹¶å‘ç°æ–°çš„æäº¤ã€‚"
          echo "ğŸš€ æ­£åœ¨è§¦å‘ 'Deploy' å·¥ä½œæµï¼Œç›®æ ‡åˆ†æ”¯: ${{ github.ref_name }}ï¼Œä»“åº“: ${OWNER_REPO}..."
          # ç¡®ä¿ 'Deploy.yml' æˆ– 'deploy.yml' æ˜¯ä½  Deploy å·¥ä½œæµçš„æ–‡ä»¶å
          # æˆ–è€…ä½¿ç”¨ Deploy å·¥ä½œæµçš„ 'name' å±æ€§å€¼
          gh workflow run Deploy.yml --ref ${{ github.ref_name }} -R ${OWNER_REPO}

      # æ­¥éª¤ 4: å¦‚æœåŒæ­¥æˆåŠŸä½†æ²¡æœ‰æ–°æäº¤ï¼Œåˆ™å‘å‡ºé€šçŸ¥
      - name: Notify if no new commits
        if: steps.sync.outcome == 'success' && steps.sync.outputs.has_new_commits != 'true'
        run: |
          echo "â„¹ï¸ ä¸Šæ¸¸åŒæ­¥æˆåŠŸï¼Œä½†æœªå‘ç°æ–°çš„æäº¤ã€‚æœªè§¦å‘éƒ¨ç½²ã€‚"

      # æ­¥éª¤ 5: å¤„ç† 'sync' æ­¥éª¤æœ¬èº«å¤±è´¥çš„æƒ…å†µ (æ‚¨åŸæœ‰çš„ Sync check é€»è¾‘)
      - name: Handle Sync Specific Failure
        # ä»…å½“ 'sync' æ­¥éª¤å¤±è´¥æ—¶æ‰§è¡Œ
        if: steps.sync.outcome == 'failure'
        run: |
          echo "âŒ [é”™è¯¯] ä¸Šæ¸¸åŒæ­¥æ“ä½œå¤±è´¥ã€‚"
          echo "åŸå› å¯èƒ½æ˜¯ä¸Šæ¸¸ä»“åº“çš„ workflow æ–‡ä»¶å‘ç”Ÿäº†å˜æ›´ï¼Œå¯¼è‡´ GitHub è‡ªåŠ¨æš‚åœäº†æœ¬æ¬¡è‡ªåŠ¨æ›´æ–°ã€‚"
          echo "æ‚¨éœ€è¦æ‰‹åŠ¨åŒæ­¥ä¸€æ¬¡æ‚¨çš„ forkã€‚è¯¦ç»†æ•™ç¨‹è¯·æŸ¥çœ‹é¡¹ç›® README.mdã€‚"
          # å¦‚æœ aormsby/Fork-Sync-With-Upstream-action æä¾›é”™è¯¯è¾“å‡ºï¼Œå¯ä»¥å°è¯•æ‰“å°
          # echo "Sync action error details: ${{ steps.sync.outputs.error_message }}"
          exit 1
